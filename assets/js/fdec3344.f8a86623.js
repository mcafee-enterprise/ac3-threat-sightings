"use strict";(self.webpackChunkac3_threat_sightings=self.webpackChunkac3_threat_sightings||[]).push([[873],{3248:function(e,t,n){var o=n(7294),a=n(7273);a.Z.initialize({startOnLoad:!0});t.Z=function(e){var t=e.chart;return(0,o.useEffect)((function(){a.Z.contentLoaded()}),[]),o.createElement("div",{className:"mermaid"},t)}},1652:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return c},contentTitle:function(){return d},metadata:function(){return l},toc:function(){return p},default:function(){return u}});var o=n(7462),a=n(3366),i=(n(7294),n(4137)),r=n(3248),s=["components"],c={},d=void 0,l={unversionedId:"Sightings/Older Schema Version/CobaltStrike",id:"Sightings/Older Schema Version/CobaltStrike",isDocsHomePage:!1,title:"CobaltStrike",description:"Summary",source:"@site/docs/03-Sightings/Older Schema Version/02-CobaltStrike.md",sourceDirName:"03-Sightings/Older Schema Version",slug:"/Sightings/Older Schema Version/CobaltStrike",permalink:"/ac3-threat-sightings/docs/Sightings/Older Schema Version/CobaltStrike",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"CVE-2021-40444",permalink:"/ac3-threat-sightings/docs/Sightings/Older Schema Version/CVE-2021-40444"},next:{title:"AutoIt3",permalink:"/ac3-threat-sightings/docs/Weapons/AutoIt3"}},p=[{value:"Summary",id:"summary",children:[{value:"Description",id:"description",children:[]}]},{value:"TTPs",id:"ttps",children:[{value:"Execution - Highly Obfuscated PowerShell command with default Cobalt Strike arguments. Service Execution.",id:"execution---highly-obfuscated-powershell-command-with-default-cobalt-strike-arguments-service-execution",children:[]},{value:"Execution - Cobalt Strike beacon started by Windows Service. Injects into RUNDLL32 and DLLHOST.",id:"execution---cobalt-strike-beacon-started-by-windows-service-injects-into-rundll32-and-dllhost",children:[]},{value:"Discovery - Automatic Discovery with BloodHound. Process Injection into DLLHOST.",id:"discovery---automatic-discovery-with-bloodhound-process-injection-into-dllhost",children:[]},{value:"Discovery - Hands-on-keyboard Discovery. Obfuscated PowerShell. ipconfig",id:"discovery---hands-on-keyboard-discovery-obfuscated-powershell-ipconfig",children:[]},{value:"Priviledge Escalation - Named Pipes Impersonation (Cobalt getSystem)",id:"priviledge-escalation---named-pipes-impersonation-cobalt-getsystem",children:[]}]},{value:"Threat Sighting YAML File",id:"threat-sighting-yaml-file",children:[]}],m={toc:p};function u(e){var t=e.components,n=(0,a.Z)(e,s);return(0,i.kt)("wrapper",(0,o.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("h3",{id:"description"},"Description"),(0,i.kt)("p",null," This Threat Sighting represent different behaviors observed during investigations that involved Cobalt Strike activity."),(0,i.kt)("h2",{id:"ttps"},"TTPs"),(0,i.kt)("h3",{id:"execution---highly-obfuscated-powershell-command-with-default-cobalt-strike-arguments-service-execution"},"Execution - Highly Obfuscated PowerShell command with default Cobalt Strike arguments. Service Execution."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Tactic"),(0,i.kt)("th",{parentName:"tr",align:null},"Technique"),(0,i.kt)("th",{parentName:"tr",align:null},"Behavior"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1569.002 - System Services: Service Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"Highly Obfuscated PowerShell command executed as Windows service.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1059.001 - Command and Scripting Interpreter: PowerShell"),(0,i.kt)("td",{parentName:"tr",align:null},"Highly Obfuscated PowerShell command executed as Windows service.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Defense Evasion"),(0,i.kt)("td",{parentName:"tr",align:null},"T1140 - Deobfuscate/Decode Files or Information"),(0,i.kt)("td",{parentName:"tr",align:null},"Highly Obfuscated PowerShell command executed as Windows service.")))),(0,i.kt)(r.Z,{chart:'\ngraph LR;\nsigh_e26ab4efb8e84e2f85b32431669f69a5["Execution - Highly Obfuscated PowerShell command with default Cobalt Strike arguments. Service Execution."];\ntyp_0["Process Created"];\nsigh_e26ab4efb8e84e2f85b32431669f69a5 --\x3e typ_0;\ntech_0["T1569.002 - System Services: Service Execution"];\ntyp_0 --\x3e tech_0;\ntech_1["T1059.001 - Command and Scripting Interpreter: PowerShell"];\ntyp_0 --\x3e tech_1;\ntech_2["T1140 - Deobfuscate/Decode Files or Information"];\ntyp_0 --\x3e tech_2;\n',mdxType:"Mermaid"}),(0,i.kt)("h3",{id:"execution---cobalt-strike-beacon-started-by-windows-service-injects-into-rundll32-and-dllhost"},"Execution - Cobalt Strike beacon started by Windows Service. Injects into RUNDLL32 and DLLHOST."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Tactic"),(0,i.kt)("th",{parentName:"tr",align:null},"Technique"),(0,i.kt)("th",{parentName:"tr",align:null},"Behavior"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1569.002 - System Services: Service Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"PE file executed from ADMIN$ folder by services.exe.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Command and Control"),(0,i.kt)("td",{parentName:"tr",align:null},"T1071 - Application Layer Protocol"),(0,i.kt)("td",{parentName:"tr",align:null},"Connected to default Cobalt Strike named pipe (MSSE-*).")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1218.011 - Signed Binary Proxy Execution: Rundll32"),(0,i.kt)("td",{parentName:"tr",align:null},"Spawned RUNDLL32 without command-line arguments.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1055.012 - Process Injection: Process Hollowing"),(0,i.kt)("td",{parentName:"tr",align:null},"Injected RUNDLL32.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Command and Control"),(0,i.kt)("td",{parentName:"tr",align:null},"T1071 - Application Layer Protocol"),(0,i.kt)("td",{parentName:"tr",align:null},"DLLHOST connected to default Cobalt Strike named pipe (postex_*).")))),(0,i.kt)(r.Z,{chart:'\ngraph LR;\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576["Execution - Cobalt Strike beacon started by Windows Service. Injects into RUNDLL32 and DLLHOST."];\ntyp_0["Process Created"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_0;\ntech_0["T1569.002 - System Services: Service Execution"];\ntyp_0 --\x3e tech_0;\ntyp_1["NamedPipe Connected"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_1;\ntech_1["T1071 - Application Layer Protocol"];\ntyp_1 --\x3e tech_1;\ntyp_2["Process Created"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_2;\ntech_2["T1218.011 - Signed Binary Proxy Execution: Rundll32"];\ntyp_2 --\x3e tech_2;\ntyp_3["Process Hollowed"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_3;\ntech_3["T1055.012 - Process Injection: Process Hollowing"];\ntyp_3 --\x3e tech_3;\ntyp_4["Process Created"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_4;\ntyp_5["NamedPipe Connected"];\nsigh_b9b5b55fdcd24d97b6cb6cdcce8fd576 --\x3e typ_5;\ntech_4["T1071 - Application Layer Protocol"];\ntyp_5 --\x3e tech_4;\n',mdxType:"Mermaid"}),(0,i.kt)("h3",{id:"discovery---automatic-discovery-with-bloodhound-process-injection-into-dllhost"},"Discovery - Automatic Discovery with BloodHound. Process Injection into DLLHOST."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Tactic"),(0,i.kt)("th",{parentName:"tr",align:null},"Technique"),(0,i.kt)("th",{parentName:"tr",align:null},"Behavior"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1018 - Remote System Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"DLLHOST performed multiple DNS Query events.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1046 - Network Service Scanning"),(0,i.kt)("td",{parentName:"tr",align:null},"DLLHOST performed hundreds of network connections to local network")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1560 - Archive Collected Data"),(0,i.kt)("td",{parentName:"tr",align:null},"DLLHOST created json files and a zip file")))),(0,i.kt)(r.Z,{chart:'\ngraph LR;\nsigh_f33125a7e43d4547a636089c40c72466["Discovery - Automatic Discovery with BloodHound. Process Injection into DLLHOST."];\ntyp_0["DNS Query"];\nsigh_f33125a7e43d4547a636089c40c72466 --\x3e typ_0;\ntech_0["T1018 - Remote System Discovery"];\ntyp_0 --\x3e tech_0;\ntyp_1["Network Accessed"];\nsigh_f33125a7e43d4547a636089c40c72466 --\x3e typ_1;\ntech_1["T1046 - Network Service Scanning"];\ntyp_1 --\x3e tech_1;\ntyp_2["File Created"];\nsigh_f33125a7e43d4547a636089c40c72466 --\x3e typ_2;\ntech_2["T1560 - Archive Collected Data"];\ntyp_2 --\x3e tech_2;\n',mdxType:"Mermaid"}),(0,i.kt)("h3",{id:"discovery---hands-on-keyboard-discovery-obfuscated-powershell-ipconfig"},"Discovery - Hands-on-keyboard Discovery. Obfuscated PowerShell. ipconfig"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Tactic"),(0,i.kt)("th",{parentName:"tr",align:null},"Technique"),(0,i.kt)("th",{parentName:"tr",align:null},"Behavior"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1016 - System Network Configuration Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"System Network Configuration Discovery with ipconfig.exe.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1087 - Account Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"Account Discovery with Net.exe.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1016 - System Network Configuration Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"System Network Configuration Discovery with nslookup.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"T1016 - System Network Configuration Discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"Discovery via Highly Obfuscated PowerShell")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Execution"),(0,i.kt)("td",{parentName:"tr",align:null},"T1059.001 - Command and Scripting Interpreter: PowerShell"),(0,i.kt)("td",{parentName:"tr",align:null},"Discovery via Highly Obfuscated PowerShell")))),(0,i.kt)(r.Z,{chart:'\ngraph LR;\nsigh_2f74b8a27ec5438c8df5d421ac337e39["Discovery - Hands-on-keyboard Discovery. Obfuscated PowerShell. ipconfig"];\ntyp_0["Process Created"];\nsigh_2f74b8a27ec5438c8df5d421ac337e39 --\x3e typ_0;\ntech_0["T1016 - System Network Configuration Discovery"];\ntyp_0 --\x3e tech_0;\ntyp_1["Process Created"];\nsigh_2f74b8a27ec5438c8df5d421ac337e39 --\x3e typ_1;\ntech_1["T1087 - Account Discovery"];\ntyp_1 --\x3e tech_1;\ntyp_2["Process Created"];\nsigh_2f74b8a27ec5438c8df5d421ac337e39 --\x3e typ_2;\ntech_2["T1016 - System Network Configuration Discovery"];\ntyp_2 --\x3e tech_2;\ntyp_3["Process Created"];\nsigh_2f74b8a27ec5438c8df5d421ac337e39 --\x3e typ_3;\ntech_3["T1016 - System Network Configuration Discovery"];\ntyp_3 --\x3e tech_3;\ntech_4["T1059.001 - Command and Scripting Interpreter: PowerShell"];\ntyp_3 --\x3e tech_4;\n',mdxType:"Mermaid"}),(0,i.kt)("h3",{id:"priviledge-escalation---named-pipes-impersonation-cobalt-getsystem"},"Priviledge Escalation - Named Pipes Impersonation (Cobalt getSystem)"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Tactic"),(0,i.kt)("th",{parentName:"tr",align:null},"Technique"),(0,i.kt)("th",{parentName:"tr",align:null},"Behavior"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Privilege Escalation"),(0,i.kt)("td",{parentName:"tr",align:null},"T1134 - Access Token Manipulation"),(0,i.kt)("td",{parentName:"tr",align:null},"Priviledge Escalation via Named Pipes Impersonation (Cobalt getSystem)")))),(0,i.kt)(r.Z,{chart:'\ngraph LR;\nsigh_c57f5c01112148fab934105cf2df8082["Priviledge Escalation - Named Pipes Impersonation (Cobalt getSystem)"];\ntyp_0["Process Created"];\nsigh_c57f5c01112148fab934105cf2df8082 --\x3e typ_0;\ntech_0["T1134 - Access Token Manipulation"];\ntyp_0 --\x3e tech_0;\n',mdxType:"Mermaid"}),(0,i.kt)("h2",{id:"threat-sighting-yaml-file"},"Threat Sighting YAML File"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"header:\n sightingReportId: 8ad76b99-b579-458c-8810-786d3e86bd79\n status: wip\n description: This Threat Sighting represent different behaviors observed during investigations that involved Cobalt Strike activity.\n author: Alejandro Houspanossian (@lekz86)\n acknowledgement: thedfirreport\n tlp: white\n threatInformation:\n   adversary:\n   - multiple\n   malware:\n   - n/d\n   lolbas:\n   - rundll32.exe\n   - dllhost.exe\n   tools:\n   - net.exe\n   - powershell.exe\n   - ipconfig.exe\n   - CobaltStrike\n   - BloodHound\n   - nslookup.exe\n   country:\n   - many\n   region:\n   - many\n   industry:\n   - many\nthreatSightings:\n- sighting: Execution - Highly Obfuscated PowerShell command with default Cobalt Strike arguments. Service Execution.\n id: e26ab4ef-b8e8-4e2f-85b3-2431669f69a5\n observables:\n - behavior: Highly Obfuscated PowerShell command executed as Windows service.\n   id: 8eb7afc6-510f-48f3-9fd1-bcc976f4ebbe\n   type: Process Created\n   process: C:\\\\Windows\\\\SysWOW64\\\\cmd.exe\n   cmdLine:\n   - /b /c start /b /min powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcAL[REDACTED]\n   notes:\n   - Command-line pattern '/b /c start /b /min powershell' used by Cobalt Strike to execute its code a service.\n   - Cobalt Strike executes PowerShell command as Windows Services.\n   - Command-line patter 'powershell -nop -w hidden -encodedcommand' used by Cobalt Strike to execute PowerShell encoded commands.\n   - Cobalt Strike executes encoded PowerShell commands to load beacons shellcode into memory.\n   att&ck:\n     execution:\n     - 'T1569.002 - System Services: Service Execution'\n     - 'T1059.001 - Command and Scripting Interpreter: PowerShell'\n     defenseEvasion:\n     - T1140 - Deobfuscate/Decode Files or Information\n- sighting: Execution - Cobalt Strike beacon started by Windows Service. Injects into RUNDLL32 and DLLHOST.\n id: b9b5b55f-dcd2-4d97-b6cb-6cdcce8fd576\n observables:\n - behavior: PE file executed from ADMIN$ folder by services.exe.\n   id: b868bc41-362a-4596-9ee8-9897557e947b\n   type: Process Created\n   process: \\\\\\\\#{IP}\\\\ADMIN$\\\\e10a2f3.exe\n   embedFilename: undefined\n   cmdLine:\n   - \\\\\\\\#{IP}\\\\ADMIN$\\\\e10a2f3.exe\n   sha256:\n   - 11D4978BF49A98F169FD82425B7CBC5DEDCD33881AE6D4CB0C5530ECC631F640\n   parentProcess: C:\\\\Windows\\\\System32\\\\services.exe\n   notes:\n   - ADMIN$ is one of the default administrative network shares in Windows.\n   - ADMIN$ is hidden, and links to C:\\\\Windows.\n   - ADMIN$ is typically used to deploy software remotely.\n   - \\\\\\\\#{IP}\\\\ADMIN$\\\\ is a probable indicator of remote execution.\n   - The filename pattern [a-z0-9]{7}.exe is known for Cobalt Strike PE beacons.\n   att&ck:\n     execution:\n     - 'T1569.002 - System Services: Service Execution'\n - behavior: Connected to default Cobalt Strike named pipe (MSSE-*).\n   id: 621ca01e-7e2c-47e6-80a3-2a23d58a2c92\n   type: NamedPipe Connected\n   pipeName: \\\\\\\\.\\\\pipe\\\\MSSE-5861-server\n   parentProcess: \\\\\\\\#{IP}\\\\ADMIN$\\\\e10a2f3.exe\n   notes:\n   - NamedPipes are an inter-process communication mechanism on Windows.\n   - NamedPipe traffic that goes host-to-host is encapsulated within the SMB protocol.\n   - NamedPipe name pattern 'MSSE-[0-9]{4}-server' is one of the default NamedPipes used by Cobalt Strike.\n   att&ck:\n     commandAndControl:\n     - T1071 - Application Layer Protocol\n - behavior: Spawned RUNDLL32 without command-line arguments.\n   id: f383e553-ff06-4b0b-bbd9-b2682bbc73d4\n   type: Process Created\n   process: C:\\\\Windows\\\\System32\\\\rundll32.exe\n   cmdLine:\n   - C:\\\\Windows\\\\System32\\\\rundll32.exe\n   parentProcess: \\\\\\\\#{IP}\\\\ADMIN$\\\\e10a2f3.exe\n   notes:\n   - RUNDLL32 is part of Windows.\n   - RUNDLL32 is used to launch functionality stored in a DLL file.\n   - RUNDLL32 without commmand-line arguments is suspicious.\n   - RUNDLL32 is default Spawn_to process for Cobalt Strike.\n   - Cobalt Strike is a post-explotaition tool widely used in attacks.\n   att&ck:\n     execution:\n     - 'T1218.011 - Signed Binary Proxy Execution: Rundll32'\n - behavior: Injected RUNDLL32.\n   id: f609d11c-b1aa-4dc3-b75b-56b175661716\n   type: Process Hollowed\n   target:\n   - C:\\\\Windows\\\\System32\\\\rundll32.exe\n   source:\n   - \\\\\\\\#{IP}\\\\ADMIN$\\\\e10a2f3.exe\n   notes:\n   - Process hollowing is a method of executing arbitrary code in the address space of a separate live process.\n   - Cobalt Strike injects into temporary processes for execution.\n   att&ck:\n     execution:\n     - 'T1055.012 - Process Injection: Process Hollowing'\n - behavior: RUNDLL32 created ~20 instances of DLLHOST without command-line arguments.\n   id: 1669ecb0-3a8a-4858-9efd-23e5c01ad643\n   type: Process Created\n   cmdLine:\n   - C:\\\\Windows\\\\System32\\\\dllhost.exe\n   process: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   parentProcess: C:\\\\Windows\\\\System32\\\\rundll32.exe\n   notes:\n   - DLLHOST (a.k.a. COM Surrogate) is intented to execute DLLs.\n   - DLLHOST without commmand-line arguments is suspicious.\n - behavior: DLLHOST connected to default Cobalt Strike named pipe (postex_*).\n   id: 1dfd3613-6b33-486b-99bb-e87a98346887\n   type: NamedPipe Connected\n   pipeName: \\\\\\\\.\\\\pipe\\\\postex_d0e7\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - NamedPipe name pattern 'postex_[a-z0-9]{4}' is one of the default NamedPipes used by Cobalt Strike.\n   att&ck:\n     commandAndControl:\n     - T1071 - Application Layer Protocol\n- sighting: Discovery - Automatic Discovery with BloodHound. Process Injection into DLLHOST.\n id: f33125a7-e43d-4547-a636-089c40c72466\n observables:\n - behavior: DLLHOST performed multiple DNS Query events.\n   id: 762daeff-39c9-4741-a255-f8dfca2ba18a\n   type: DNS Query\n   protocol: tcp\n   name:\n   - SQL03.COMPANY.COM\n   - SQL02.COMPANY.COM\n   - DEV01.COMPANY.COM\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   att&ck:\n     discovery:\n     - T1018 - Remote System Discovery\n - behavior: DLLHOST performed hundreds of network connections to local network\n   id: ced277c3-f68a-42b5-b153-55e1983d17ec\n   type: Network Accessed\n   connections:\n   - protocol: tcp\n     dstIp:\n     - '#{PRIVATEIP}'\n     dstPort:\n     - 445\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - The srcPort is high port number, eg. 63794.\n   att&ck:\n     discovery:\n     - T1046 - Network Service Scanning\n - behavior: DLLHOST created json files and a zip file\n   id: 00e87649-62aa-41c0-92d3-93bccf268b8f\n   type: File Created\n   files:\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_users.json\n     name: 20210101190124_users.json\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_computers.json\n     name: 20210101190124_computers.json\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_groups.json\n     name: 20210101190124_groups.json\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_ous.json\n     name: 20210101190124_ous.json\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_gpos.json\n     name: 20210101190124_gpos.json\n   - path: C:\\\\Windows\\\\System32\\\\20210101190124_BloodHound.zip\n     name: 20210101190124_BloodHound.zip\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - BloodHound is an Active Directory (AD) reconnaissance tool.\n   - BloodHound outputs results as JSON files\n   - BloodHound can collect information about the following objects (users, computers, groups, gpos)\n   - BloodHound can archive collected a ZIP file\n   att&ck:\n     discovery:\n     - T1560 - Archive Collected Data\n- sighting: Discovery - Hands-on-keyboard Discovery. Obfuscated PowerShell. ipconfig\n id: 2f74b8a2-7ec5-438c-8df5-d421ac337e39\n observables:\n - behavior: System Network Configuration Discovery with ipconfig.exe.\n   id: cabd27ff-28f6-41bd-85cc-8860ab136782\n   type: Process Created\n   cmdLine:\n   - ipconfig /all\n   process: C:\\\\Windows\\\\System32\\\\ipconfig.exe\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - ipconfig displays all current TCP/IP network configuration values and refreshes Dynamic Host Configuration Protocol (DHCP) and Domain Name System (DNS) settings\n   - Cobalt Strike typically injects into legit system processes\n   att&ck:\n     discovery:\n     - T1016 - System Network Configuration Discovery\n - behavior: Account Discovery with Net.exe.\n   id: 8f233e51-284c-4423-823f-ce3aedf5e03a\n   type: Process Created\n   cmdLine:\n   - net users\n   - net users /domain\n   process: C:\\\\Windows\\\\System32\\\\net.exe\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - The Net utility is a component of the Windows operating system. It is used in command-line operations for control of users, groups, services, and network connections.\n   - Cobalt Strike typically injects into legit system processes\n   att&ck:\n     discovery:\n     - T1087 - Account Discovery\n - behavior: System Network Configuration Discovery with nslookup.\n   id: 5ac96747-ca6c-4ee2-bc55-0048a82c6afc\n   type: Process Created\n   cmdLine:\n   - nslookup\n   process: C:\\\\Windows\\\\System32\\\\nslookup.exe\n   parentProcess: C:\\\\Windows\\\\System32\\\\dllhost.exe\n   notes:\n   - Nslookup is a network administration command-line tool for querying the Domain Name System to obtain the mapping between domain name and IP address, or other DNS records.\n   - Cobalt Strike typically injects into legit system processes\n   att&ck:\n     discovery:\n     - T1016 - System Network Configuration Discovery\n - behavior: Discovery via Highly Obfuscated PowerShell\n   id: 4a17d5ad-cbad-4363-b6ed-85644a92069e\n   type: Process Created\n   cmdLine:\n   - ipconfig /all\n   process: C:\\\\Windows\\\\System32\\\\ipconfig.exe\n   parentProcess: C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\n   att&ck:\n     discovery:\n     - T1016 - System Network Configuration Discovery\n     execution:\n     - 'T1059.001 - Command and Scripting Interpreter: PowerShell'\n- sighting: Priviledge Escalation - Named Pipes Impersonation (Cobalt getSystem)\n id: c57f5c01-1121-48fa-b934-105cf2df8082\n observables:\n - behavior: Priviledge Escalation via Named Pipes Impersonation (Cobalt getSystem)\n   id: 310f5757-59b0-4cff-994a-2921d2d52cfc\n   type: Process Created\n   process: C:\\\\Windows\\\\system32\\\\cmd.exe\n   cmdLine:\n   - C:\\\\Windows\\\\system32\\\\cmd.exe /c echo 675f2d61c15 > \\\\\\\\.\\\\pipe\\\\526c8c\n   att&ck:\n     privilegeEscalation:\n     - T1134 - Access Token Manipulation\nthreatHunting:\n- query: Hunt for Suspicious Process execution via Services.exe\n queryId: 65e91ae8-2140-4465-8329-693fb1dcb638\n type: sigma\n behaviorIds:\n - b868bc41-362a-4596-9ee8-9897557e947b\n - 8eb7afc6-510f-48f3-9fd1-bcc976f4ebbe\n logsource:\n   category: process_creation\n   product: windows\n detection:\n   parent:\n     ParentImage|endswith:\n     - \\\\services.exe\n   selection1:\n     Image|re: '*ADMIN$\\\\[a-z0-9]{7}.exe'\n   selection2:\n     CommandLine|contains:\n     - /b /c start /b /min powershell\n     - -nop -w hidden -encodedcommand\n   condition: parent AND (selection1 OR selection2)\n- query: Hunt for Automated discovery\n queryId: 7bec5230-5e8d-4ba0-99b0-92d9a86b00a7\n type: sigma\n behaviorIds:\n - 00e87649-62aa-41c0-92d3-93bccf268b8f\n logsource:\n   category: file_creation\n   product: windows\n detection:\n   selection:\n     FileName|re: '[0-9]{14}_BloodHound.zip'\n   condition: selection\n- query: Hunt for Suspicious Process Injection\n queryId: f3f5821f-4d8b-4c6f-ab60-c8d6200561c4\n type: sigma\n behaviorIds:\n - f383e553-ff06-4b0b-bbd9-b2682bbc73d4\n logsource:\n   category: process_creation\n   product: windows\n detection:\n   parent1:\n     ParentImage|endswith:\n     - \\\\powershell.exe\n   parent2:\n     ParentImage|contains:\n     - ADMIN$\n   selection3:\n     CommandLine|endswith:\n     - \\\\rundll32.exe\n     - \\\\dllhost.exe\n     - \\\\sysnative\\\\mstsc.exe\n     - \\\\sysnative\\\\net.exe\n     - \\\\sysnative\\\\svchost.exe\n     - \\\\sysnative\\\\lsass.exe\n     - \\\\sysnative\\\\dllhost.exe\n     - \\\\sysnative\\\\lsass.exe\n     - \\\\sysnative\\\\gpupdate.exe\n     - \\\\sysnative\\\\svchost.exe -k netsvcs\n   condition: (parent1 OR parent2) AND selection3\n- query: Hunt for Suspicious Process Execution from ADMIN$\n queryId: be6f5897-db49-456a-bea7-74cca07bb2c3\n type: sigma\n behaviorIds:\n - f383e553-ff06-4b0b-bbd9-b2682bbc73d4\n logsource:\n   category: process_creation\n   product: windows\n detection:\n   geno:\n     ParentImage|re: '*ADMIN$\\\\[a-z0-9]{7}.exe'\n     CommandLine|contains:\n     - \\\\Windows\\\\System32\\\\\n     - \\\\Windows\\\\SysWow64\\\\\n     - \\\\Windows\\\\Sysnative\\\\\n   condition: geno\nfooter:\n changeTracking:\n   created: 2021-09-01\n   lastModified: 2021-11-18\n   sightingVersion: 1.7\n   schemaVersion: 1.6\n references:\n - https://nasbench.medium.com/what-is-the-dllhost-exe-process-actually-running-ef9fe4c19c08\n - https://attack.mitre.org/techniques/T1055/012/\n - https://blog.cobaltstrike.com/2019/08/21/cobalt-strikes-process-injection-the-details-cobalt-strike/\n - https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/\n")))}u.isMDXComponent=!0}}]);